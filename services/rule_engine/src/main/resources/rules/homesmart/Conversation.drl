package rules.homesmart;

import java.util.Date;

import com.mindsmiths.ruleEngine.util.Log;
import com.mindsmiths.telegramAdapter.TelegramKeyboardAnswered;
import com.mindsmiths.telegramAdapter.TelegramReceivedMessage;
import com.mindsmiths.ruleEngine.model.Initialize;
import com.mindsmiths.ruleEngine.model.Heartbeat;

import agents.Homesmart;


rule "First contact"
    salience 100
    when
        initialize: Initialize() from entry-point "agent-created"
        message: TelegramReceivedMessage() from entry-point "signals"
        agent: Homesmart()
    then
        modify(agent) {
            sendMessage("Hello, my name is Homesmart, a smart Real Estate agent!");
            sendInterestQuestionare();
            setUserId(message.getText())
        }
        delete(message);
end

rule "Re-engage costumer"
    when
        Heartbeat(ts: timestamp) from entry-point "signals"
        agent: Homesmart(
            lastInteractionTime before[30s] ts
        )
    then
        modify(agent) {
            setLastInteractionTime(new Date())
            sendInterestQuestionare();
        };
end

rule "Process customer answer"
    when
        answer: TelegramKeyboardAnswered() from entry-point "signals"
        agent: Homesmart()
    then
        modify(agent) {
            setCostumerAnswer(answer.getAnswer())
        };
        DB_AdapterAPI.fetch_user();
end

rule "Fetch user"
    when
        user: FetchResult() from entry-point "signals"
        agent: Homesmart()
    then
        modify(agent) {
            updateUserAnswer(answer)
        };
end