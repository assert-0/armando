package rules.armando;

import java.util.Date;

import com.mindsmiths.dbAdapter.DBAdapterAPI;
import com.mindsmiths.dbAdapter.FetchResult;
import com.mindsmiths.ruleEngine.util.Log;
import com.mindsmiths.telegramAdapter.TelegramReceivedMessage;
import com.mindsmiths.ruleEngine.model.Initialize;
import com.mindsmiths.ruleEngine.model.Heartbeat;
import com.mindsmiths.telegramAdapter.TelegramKeyboardAnswered;
import com.mindsmiths.ruleEngine.util.Log;

import agents.Armando;


rule "First contact"
    salience 100
    when
        initialize: Initialize() from entry-point "agent-created"
        agent: Armando()
    then
        modify(agent) {
            sendMessage("Hello, my name is Armando, a smart Real Estate agent!"),
            sendInterestQuestionare()
        }
        delete(initialize);
end

rule "Re-engage costumer"
    when
        Heartbeat(ts: timestamp) from entry-point "signals"
        agent: Armando(
            lastInteractionTime before[30s] ts
        )
    then
        modify(agent) {
            setLastInteractionTime(new Date()),
            sendInterestQuestionare()
        };
end

rule "Process customer answer"
    when
        answer: TelegramKeyboardAnswered() from entry-point "signals"
        agent: Armando()
    then
        insert(answer);
        DBAdapterAPI.fetchUser(agent.getUserId());
end

rule "Update user"
    when
        res: FetchResult(success == true) from entry-point "signals"
        answer: TelegramKeyboardAnswered()
        agent: Armando()
    then
        Log.info(res);
        agent.handleFetchResult(res.getUsers().get(0), answer.getAnswer());
        agent.sendUserSignal(answer.getAnswer());
        delete(res);
        delete(answer);
end
