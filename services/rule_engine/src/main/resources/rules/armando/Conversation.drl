package rules.armando;

import java.util.Date;

import com.mindsmiths.dbAdapter.DBAdapterAPI;
import com.mindsmiths.dbAdapter.FetchResult;
import com.mindsmiths.ruleEngine.util.Log;
import com.mindsmiths.telegramAdapter.TelegramReceivedMessage;
import com.mindsmiths.ruleEngine.model.Initialize;
import com.mindsmiths.ruleEngine.model.Heartbeat;
import com.mindsmiths.telegramAdapter.TelegramKeyboardAnswered;
import com.mindsmiths.telegramAdapter.TelegramMultiChoiceKeyboardAnswered;
import com.fasterxml.jackson.databind.node.ObjectNode;

import com.mindsmiths.armory.events.ArmoryEvent; 
import com.mindsmiths.armory.events.SubmitEvent; 
import com.mindsmiths.armory.events.UserConnectedEvent; 
import com.mindsmiths.armory.events.UserDisconnectedEvent;

import agents.Armando;


rule "First contact"
    salience 100
    when
        initialize: Initialize() from entry-point "agent-created"
        agent: Armando()
    then
        agent.sendMessage("Hello, my name is Armando, a smart Real Estate agent!");
        DBAdapterAPI.fetchUser(agent.getUserId());
        modify(agent) {
            addConnection("armory", agent.getConnections().get("telegram"))
        };
        System.out.println(agent.toString());
        delete(initialize);
end

rule "Receive user data"
    when
        res: FetchResult(success == true) from entry-point "signals"
        agent: Armando()
    then
        Log.warn("Fetched user!");
        modify(agent) {
            setUser(res.getUsers().get(0))
        };
        agent.displayUI();
        agent.sendInterestQuestionare();
        delete(res);
end

rule "Re-engage costumer"
    when
        Heartbeat(ts: timestamp) from entry-point "signals"
        agent: Armando(
            lastInteractionTime before[30s] ts
        )
    then
        modify(agent) {
            setLastInteractionTime(new Date())
        };
end

rule "Process customer answer"
    when
        answer: TelegramKeyboardAnswered() from entry-point "signals"
        agent: Armando()
    then
        modify(agent) {
            setQuestions(answer.getAnswer().equals("YES") ? agent.YesQuestions : agent.NoQuestions)
        }
        agent.updateUserInterest(answer.getAnswer());
        agent.sendNextQuestion();
        delete(answer);
end

rule "Receive answer"
    when
        answer: TelegramMultiChoiceKeyboardAnswered() from entry-point "signals"
        agent: Armando()
    then
        agent.handleAnswer(answer.getAnswers());
        delete(answer);
end

rule "User connected event"
    when 
        event: UserConnectedEvent() from entry-point "signals"
        agent: Armando()
    then
        agent.displayUI();
        delete(event);
end

rule "Armory submit"
    when
        event: SubmitEvent() from entry-point "signals"
        agent: Armando()
    then
        if (event.getData().get("submit").asText().equals("1")) agent.setReIndex((agent.getReIndex() + 1) % 3);
        else agent.setReIndex(((agent.getReIndex() - 1) + ) % 3);
        agent.displayUI();
        delete(event);
end
